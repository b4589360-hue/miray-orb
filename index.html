<<<script>
  const orb = document.querySelector(".orb");
  const statusEl = document.getElementById("status");
  const textEl = document.getElementById("text");

  function pickTurkishVoice() {
    const voices = speechSynthesis.getVoices() || [];
    return voices.find(v => (v.lang || "").toLowerCase().startsWith("tr")) || null;
  }

  function speak(text) {
    try {
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "tr-TR";
      u.rate = 1.0;
      u.pitch = 0.9;
      const v = pickTurkishVoice();
      if (v) u.voice = v;
      speechSynthesis.speak(u);
    } catch (e) {
      alert("Ses hatası: " + e.message);
    }
  }

  // ---- Dinleme (STT) ----
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  let listening = false;

  if (!SR) {
    statusEl.textContent = "Bu tarayıcı STT desteklemiyor (Chrome kullan).";
  } else {
    rec = new SR();
    rec.lang = "tr-TR";
    rec.continuous = false;
    rec.interimResults = false;

    rec.onstart = () => {
      listening = true;
      statusEl.textContent = "Dinliyorum...";
      orb.style.transform = "scale(1.2)";
    };

    rec.onresult = (e) => {
      const t = e.results?.[0]?.[0]?.transcript || "";
      textEl.textContent = "Sen: " + t;
      // Basit cevap örneği:
      if (t.toLowerCase().includes("selam")) speak("Aleyküm selam Bünyamin.");
      else speak("Efendim Bünyamin, dinledim.");
    };

    rec.onerror = (e) => {
      statusEl.textContent = "Hata: " + e.error;
      speak("Mikrofon izni lazım olabilir.");
    };

    rec.onend = () => {
      listening = false;
      statusEl.textContent = "Hazır (dokun ve konuş)";
      orb.style.transform = "";
    };
  }

  function startListen() {
    if (!rec) return;
    try {
      rec.abort(); // bazı Androidlerde takılmayı çözer
      rec.start();
    } catch (e) {
      // hızlı tıklamada bazen "already started" olur, görmezden gel
    }
  }

  // 1 dokunuş: "Efendim" + dinlemeyi başlat
  orb.addEventListener("click", () => {
    speak("Efendim Bünyamin");
    startListen();
  });

  // ses listesi geç gelirse
  speechSynthesis.onvoiceschanged = () => {};
  speechSynthesis.getVoices();
</script>